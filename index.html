<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>哈尔滨&沈阳红色地图</title>
    <!-- 引入Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            height: 100vh;
        }

        #coordinate-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px;
            border: 1px solid #ccc;
            z-index: 1000;
            display: none;
        }

        #nearest-points {
            position: fixed;
            bottom: 20px;
            left: 10px;
            background: rgba(255, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid #8B0000;
            border-radius: 8px;
            z-index: 1000;
            max-width: 70%;
            display: none;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #nearest-points ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #nearest-points li {
            cursor: pointer;
            margin: 5px 0;
            color: gold;
        }

        #nearest-points li:hover {
            color: goldenrod;
            text-decoration: underline;
        }

        #nearest-points h4 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        /* 自定义定位按钮 */
        .leaflet-control-locate {
            background: white;
            background-clip: padding-box;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            padding: 0;
        }

        .leaflet-control-locate.active:hover {
            background: #f4f4f4;
        }

        #locate-icon {
            stroke-width: 3;
            stroke: #A9A9A9;
        }

        /* 侧边栏样式 */
        #sidebar {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(255, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid #8B0000;
            border-radius: 8px;
            z-index: 1000;
            width: 200px;
            transition: transform 0.3s ease;
            transform: translateX(-120%);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        #sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 0, 0, 0.8);
            border: 2px solid #8B0000;
            border-radius: 4px;
            padding: 5px;
            cursor: pointer;
            z-index: 1001;
            color: white;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #sidebar-toggle:hover {
            color: #f4f4f4;
            background-color: rgba(255, 64, 64, 0.8);
        }

        #sidebar ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #sidebar li {
            cursor: pointer;
            margin: 10px 0;
            color: gold;
        }

        #sidebar li:hover {
            color: goldenrod;
            text-decoration: underline;
        }

        /* 导航栏样式 */
        #location-nav {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-around;
        }

        #location-nav button {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #8B0000;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            color: #8B0000;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s ease, color 0.3s ease;
        }

        #location-nav button:hover {
            background: #8B0000;
            color: white;
        }

        #location-nav button.active {
            background: #8B0000;
            color: white;
        }
    </style>
    <!-- 引入Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="leaflet.mapCorrection.js"></script>
</head>

<body>
    <div id="map"></div>
    <!-- 显示经纬度的容器 -->
    <div id="coordinate-display">
        经纬度: <span id="coordinates">-</span>
    </div>
    <!-- 显示最近路径点的容器 -->
    <div id="nearest-points">
        <h4>离你最近的红色景点：</h4>
        <ul id="nearest-points-list"></ul>
    </div>
    <!-- 侧边栏 -->
    <div id="sidebar">
        <nav id="location-nav">
            <button data-location="哈尔滨">哈尔滨</button>
            <button data-location="沈阳">沈阳</button>
        </nav>
        <ul id="sidebar-list"></ul>
    </div>
    <!-- 侧边栏展开/收起按钮 -->
    <div id="sidebar-toggle">☰</div>

    <script>
        // 动态调整地图高度
        function setMapHeight() {
            let map = document.getElementById('map');
            map.style.height = window.innerHeight + 'px';
        }

        setMapHeight();

        window.addEventListener('resize', setMapHeight);
        window.addEventListener('orientationchange', setMapHeight);

        // 常量：初始坐标
        const INITIAL_LAT = 45.761; // 纬度
        const INITIAL_LNG = 126.631; // 经度
        const DEFAULT_ZOOM = 14; // 默认缩放级别
        const MIN_UPDATE_DIST = 20;
        let userLat = INITIAL_LAT;
        let userLng = INITIAL_LNG;

        // 检测是否为移动端
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // 初始化地图
        let map = L.map('map').setView([INITIAL_LAT, INITIAL_LNG], DEFAULT_ZOOM);

        // 添加地图图层（高德地图）
        L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: '地图数据 &copy; <a href="https://www.amap.com/">高德地图</a>',
            coordType: 'gcj02'
        }).addTo(map);

        // 根据设备类型决定是否显示经纬度
        document.getElementById('coordinate-display').style.display = isMobile() ? 'none' : 'block';

        map.zoomControl.setPosition('bottomright');

        // 自定义定位按钮
        let locateControl = L.Control.extend({
            options: {
                position: 'bottomright'
            },
            onAdd: function (map) {
                let container = L.DomUtil.create('div', 'leaflet-control-locate');
                container.innerHTML = `
                    <svg width="30" height="30" viewbox="-5 -5 40 40" id="locate-icon">

                        <circle cx="15" cy="15" r="10" fill="transparent" />
                        <circle cx="15" cy="15" r="1" fill="transparent" />

                        <line x1="25" x2="30" y1="15" y2="15" />
                        <line x1="5" x2="0" y1="15" y2="15" />
                        <line y1="25" y2="30" x1="15" x2="15" />
                        <line y1="5" y2="0" x1="15" x2="15" />

                    </svg>
                `;
                container.title = '定位功能暂不可用';

                // 点击按钮时定位到用户位置
                container.onclick = function () {
                    if (this.classList.contains('active')) {
                        map.setView([userLat, userLng], DEFAULT_ZOOM); // 定位到用户位置并恢复默认缩放
                    } else {
                        console.log('无效的定位请求');
                    }
                };

                return container;
            }
        });

        // 添加定位按钮到地图
        let locateControlInstance = new locateControl();
        map.addControl(locateControlInstance);

        // 定义用户定位点的图标（默认图标，恢复原始大小）
        let userIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png', // 默认图标
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // 定义路径点的图标
        let pathPointIcon = L.icon({
            iconUrl: 'https://cdn.luogu.com.cn/upload/image_hosting/ulvs2stg.png', // 自定义图标
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // 存储路径点数据
        let pathPoints = [];

        // 动态加载路径点数据
        fetch('pathPoints.json')
            .then(response => response.json())
            .then(data => {
                pathPoints = data; // 存储路径点数据

                // 按路径点title的字典序排序
                pathPoints.sort((a, b) => a.title.localeCompare(b.title));

                // 初始化显示所有路径点
                pathPoints.forEach(function (point) {
                    let marker = L.marker([point.lat, point.lng], { icon: pathPointIcon }).addTo(map);
                    let popupContent = `
                    <b>${point.title}</b><br>
                    <img src="${point.image}" alt="${point.title}" style="width:100%;"><br>
                    ${point.content ?? '这是' + point.title}<br>
                `;
                    marker.bindPopup(popupContent);
                    marker.on('click', function () {
                        marker.openPopup();
                    });
                });

                // 显示哈尔滨的路径点

                updateSidebar(pathPoints.filter(point => point.location === '哈尔滨'));
                document.querySelector('#location-nav button').classList.add('active');

                // 导航栏按钮点击事件
                document.querySelectorAll('#location-nav button').forEach(button => {
                    button.addEventListener('click', function () {
                        let location = this.getAttribute('data-location');
                        let filteredPoints = pathPoints.filter(point => point.location === location);

                        // 更新侧边栏
                        updateSidebar(filteredPoints);

                        // 设置按钮的激活状态
                        document.querySelectorAll('#location-nav button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
            })
            .catch(error => {
                console.error('加载路径点数据失败:', error);
            });

        // 更新侧边栏的函数
        function updateSidebar(points) {
            // 更新侧边栏中的路径点
            let sidebarList = document.getElementById('sidebar-list');
            sidebarList.innerHTML = points.map(point => `
                <li data-lat="${point.lat}" data-lng="${point.lng}">
                    ${point.title}
                </li>
            `).join('');

            // 点击侧边栏中的路径点时，定位到该路径点
            sidebarList.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', function () {
                    let lat = parseFloat(this.getAttribute('data-lat'));
                    let lng = parseFloat(this.getAttribute('data-lng'));
                    map.setView([lat, lng], DEFAULT_ZOOM); // 定位到路径点
                });
            });
        }

        // 定义用户标记变量
        let userMarker = null;

        // 定位功能
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                function (position) {
                    let lstLat = userLat;
                    let lstLng = userLng;
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    console.log('用户在北纬 ' + userLat + '，东经 ' + userLng);
                    console.log(userMarker === null);

                    if (userMarker !== null && calculateDistance(userLat, userLng, lstLat, lstLng) < MIN_UPDATE_DIST) {
                        userLat = lstLat;
                        userLng = lstLng;
                        return;
                    }


                    // 如果用户标记不存在，则创建
                    if (userMarker === null) {
                        userMarker = L.marker([userLat, userLng], { icon: userIcon }).addTo(map)
                            .bindPopup('你在这里').openPopup();
                        map.setView([userLat, userLng], DEFAULT_ZOOM); // 本来只会初始的时候重新定中心的，怎么这地图中心老是飘呢
                    } else {
                        // 如果用户标记已存在，则更新位置
                        console.log(calculateDistance(userLat, userLng, lstLat, lstLng) + 'm');

                        let center = map.getCenter();

                        userMarker.setLatLng([userLat, userLng]); // 得出结论，进行完这一步后地图会闪现，但这函数是库里的，根本看不懂库的逻辑

                        map.setView([center.lat, center.lng]); // 没办法了，你闪现就闪现吧，闪现之后老子给你强制拉回来，尽管这个函数本不应该在此调用的
                    }

                    // 显示最近路径点容器
                    document.getElementById('nearest-points').style.display = 'block';
                    document.getElementById('locate-icon').style.stroke = '#0091ff';
                    document.querySelector('.leaflet-control-locate').classList.add('active');
                    document.querySelector('.leaflet-control-locate').title = '定位到我的位置';

                    // 计算并显示最近的路径点
                    calculateAndDisplayNearestPoints(userLat, userLng);
                },
                function (error) {
                    console.error("Error Code = " + error.code + " - " + error.message);

                    if (error.code === error.PERMISSION_DENIED) {
                        alert("建议打开定位功能以体验本网站的全部功能\n本网站没有后端服务，位置信息仅用于本地服务");
                    }
                },
                {
                    enableHighAccuracy: false,
                    timeout: 5000, // 超时时间（毫秒）
                    maximumAge: 0
                }
            );
        } else {
            alert("你的浏览器不支持地理定位功能。");
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            let R = 6371000; // 地球半径，单位：米
            let dLat = (lat2 - lat1) * Math.PI / 180;
            let dLng = (lng2 - lng1) * Math.PI / 180;
            let a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // 格式化距离显示
        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)} m`; // 小于1公里，显示米，保留整数
            } else {
                return `${(distance / 1000).toFixed(1)} km`; // 大于或等于1公里，显示公里，保留1位小数
            }
        }

        // 计算并显示最近的路径点
        function calculateAndDisplayNearestPoints(userLat, userLng) {
            let pointsWithDistance = pathPoints.map(point => {
                let distance = calculateDistance(userLat, userLng, point.lat, point.lng);
                return { ...point, distance };
            });

            pointsWithDistance.sort((a, b) => a.distance - b.distance);

            let nearestPoints = pointsWithDistance.slice(0, 2);

            // 显示在左下角
            let nearestPointsList = document.getElementById('nearest-points-list');
            nearestPointsList.innerHTML = nearestPoints.map(point => `
                <li data-lat="${point.lat}" data-lng="${point.lng}">
                    ${point.title} - ${formatDistance(point.distance)}
                </li>
            `).join('');

            // 点击最近路径点时，定位到该路径点
            nearestPointsList.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', function () {
                    let lat = parseFloat(this.getAttribute('data-lat'));
                    let lng = parseFloat(this.getAttribute('data-lng'));
                    map.setView([lat, lng], DEFAULT_ZOOM); // 定位到路径点
                });
            });
        }

        map.on('mousemove', function (e) {
            // 获取鼠标位置的经纬度
            let lat = (e.latlng.lat).toFixed(6);
            let lng = (e.latlng.lng).toFixed(6);

            // 更新显示经纬度的内容
            document.getElementById('coordinates').textContent = lat + ', ' + lng;
        });

        // 当鼠标移出地图时，清空显示
        map.on('mouseout', function () {
            document.getElementById('coordinates').textContent = '-';
        });

        // 侧边栏展开/收起功能
        document.getElementById('sidebar-toggle').addEventListener('click', function () {
            let sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        });

        document.querySelector('.leaflet-control-zoom-in').title = '放大';
        document.querySelector('.leaflet-control-zoom-out').title = '缩小';
    </script>
</body>

</html>