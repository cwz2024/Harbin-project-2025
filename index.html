<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ˆå°”æ»¨çº¢è‰²åœ°å›¾</title>
    <!-- å¼•å…¥Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
        }

        #coordinate-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px;
            border: 1px solid #ccc;
            z-index: 1000;
        }

        #nearest-points {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
            max-width: 300px;
        }

        #nearest-points ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #nearest-points li {
            cursor: pointer;
            margin: 5px 0;
            color: blue;
            text-decoration: underline;
        }

        /* è‡ªå®šä¹‰å®šä½æŒ‰é’® */
        .leaflet-control-locate {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            cursor: pointer;
        }

        .leaflet-control-locate:hover {
            background: #f4f4f4;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <!-- æ˜¾ç¤ºç»çº¬åº¦çš„å®¹å™¨ -->
    <div id="coordinate-display">
        ç»çº¬åº¦: <span id="coordinates">-</span>
    </div>
    <!-- æ˜¾ç¤ºæœ€è¿‘è·¯å¾„ç‚¹çš„å®¹å™¨ -->
    <div id="nearest-points">
        <h4>ç¦»ä½ æœ€è¿‘çš„çº¢è‰²æ™¯ç‚¹ï¼š</h4>
        <ul id="nearest-points-list"></ul>
    </div>

    <!-- å¼•å…¥Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // å¸¸é‡ï¼šåˆå§‹åæ ‡
        const INITIAL_LAT = 30.3; // çº¬åº¦
        const INITIAL_LNG = 112.2; // ç»åº¦
        const DEFAULT_ZOOM = 13; // é»˜è®¤ç¼©æ”¾çº§åˆ«

        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        var zoomControlPosition = isMobile() ? 'topleft' : 'bottomright';
        var locateControlPosition = isMobile() ? 'topleft' : 'bottomright';

        // åˆå§‹åŒ–åœ°å›¾
        var map = L.map('map').setView([INITIAL_LAT, INITIAL_LNG], DEFAULT_ZOOM);

        // æ·»åŠ åœ°å›¾å›¾å±‚ï¼ˆé«˜å¾·åœ°å›¾ï¼‰
        L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: 'åœ°å›¾æ•°æ® &copy; <a href="https://www.amap.com/">é«˜å¾·åœ°å›¾</a>'
        }).addTo(map);

        // å°†ç¼©æ”¾æ§ä»¶ç§»åŠ¨åˆ°å³ä¸‹è§’
        map.zoomControl.setPosition(zoomControlPosition);

        // è‡ªå®šä¹‰å®šä½æŒ‰é’®
        var locateControl = L.Control.extend({
            options: {
                position: locateControlPosition
            },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-control-locate');
                container.innerHTML = 'ğŸ“'; // æŒ‰é’®å›¾æ ‡
                container.title = 'å®šä½åˆ°æˆ‘çš„ä½ç½®';
                container.style.fontSize = '20px';
                container.style.textAlign = 'center';
                container.style.width = '30px';
                container.style.height = '30px';
                container.style.lineHeight = '30px';

                // ç‚¹å‡»æŒ‰é’®æ—¶å®šä½åˆ°ç”¨æˆ·ä½ç½®
                container.onclick = function () {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;
                            map.setView([lat, lng], DEFAULT_ZOOM); // å®šä½åˆ°ç”¨æˆ·ä½ç½®å¹¶æ¢å¤é»˜è®¤ç¼©æ”¾
                        }, function (error) {
                            console.error("Error Code = " + error.code + " - " + error.message);
                        });
                    } else {
                        alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚");
                    }
                };

                return container;
            }
        });

        // æ·»åŠ å®šä½æŒ‰é’®åˆ°åœ°å›¾
        map.addControl(new locateControl());

        // å®šä¹‰ç”¨æˆ·å®šä½ç‚¹çš„å›¾æ ‡ï¼ˆé»˜è®¤å›¾æ ‡ï¼‰
        var userIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png', // é»˜è®¤å›¾æ ‡
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // å®šä¹‰è·¯å¾„ç‚¹çš„å›¾æ ‡
        var pathPointIcon = L.icon({
            iconUrl: 'https://cdn.luogu.com.cn/upload/image_hosting/ulvs2stg.png', // è‡ªå®šä¹‰å›¾æ ‡
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // å­˜å‚¨è·¯å¾„ç‚¹æ•°æ®
        var pathPoints = [];

        // åŠ¨æ€åŠ è½½è·¯å¾„ç‚¹æ•°æ®
        fetch('pathPoints.json')
            .then(response => response.json())
            .then(data => {
                pathPoints = data; // å­˜å‚¨è·¯å¾„ç‚¹æ•°æ®
                data.forEach(function (point) {
                    var marker = L.marker([point.lat, point.lng], { icon: pathPointIcon }).addTo(map)
                        .bindPopup(`<b>${point.title}</b><br>${point.content}`);
                    marker.on('click', function () {
                        marker.openPopup();
                    });
                });
            })
            .catch(error => {
                console.error('åŠ è½½è·¯å¾„ç‚¹æ•°æ®å¤±è´¥:', error);
            });

        // å®šä½åŠŸèƒ½
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLat = position.coords.latitude;
                var userLng = position.coords.longitude;

                // å®šä½åˆ°ç”¨æˆ·ä½ç½®
                map.setView([userLat, userLng], DEFAULT_ZOOM);
                L.marker([userLat, userLng], { icon: userIcon }).addTo(map)
                    .bindPopup('ä½ åœ¨è¿™é‡Œ').openPopup();

                // è®¡ç®—ç”¨æˆ·ä½ç½®ä¸è·¯å¾„ç‚¹çš„è·ç¦»
                calculateAndDisplayNearestPoints(userLat, userLng);
            }, function (error) {
                console.error("Error Code = " + error.code + " - " + error.message);
            });
        } else {
            alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚");
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            var R = 6371000; // åœ°çƒåŠå¾„ï¼Œå•ä½ï¼šç±³
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)} m`; // å°äº1å…¬é‡Œï¼Œæ˜¾ç¤ºç±³ï¼Œä¿ç•™æ•´æ•°
            } else {
                return `${(distance / 1000).toFixed(1)} km`; // å¤§äºæˆ–ç­‰äº1å…¬é‡Œï¼Œæ˜¾ç¤ºå…¬é‡Œï¼Œä¿ç•™1ä½å°æ•°
            }
        }

        // è®¡ç®—å¹¶æ˜¾ç¤ºæœ€è¿‘çš„è·¯å¾„ç‚¹
        function calculateAndDisplayNearestPoints(userLat, userLng) {
            var pointsWithDistance = pathPoints.map(point => {
                var distance = calculateDistance(userLat, userLng, point.lat, point.lng);
                return { ...point, distance };
            });

            pointsWithDistance.sort((a, b) => a.distance - b.distance);

            var nearestPoints = pointsWithDistance.slice(0, 2);

            // æ˜¾ç¤ºåœ¨å·¦ä¸‹è§’
            var nearestPointsList = document.getElementById('nearest-points-list');
            nearestPointsList.innerHTML = nearestPoints.map(point => `
                <li data-lat="${point.lat}" data-lng="${point.lng}">
                    ${point.title} - ${formatDistance(point.distance)}
                </li>
            `).join('');

            // ç‚¹å‡»æœ€è¿‘è·¯å¾„ç‚¹æ—¶ï¼Œå®šä½åˆ°è¯¥è·¯å¾„ç‚¹
            nearestPointsList.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', function () {
                    var lat = parseFloat(this.getAttribute('data-lat'));
                    var lng = parseFloat(this.getAttribute('data-lng'));
                    map.setView([lat, lng], DEFAULT_ZOOM); // å®šä½åˆ°è·¯å¾„ç‚¹
                });
            });
        }

        map.on('mousemove', function (e) {
            // è·å–é¼ æ ‡ä½ç½®çš„ç»çº¬åº¦
            var lat = e.latlng.lat.toFixed(6);
            var lng = e.latlng.lng.toFixed(6);

            // æ›´æ–°æ˜¾ç¤ºç»çº¬åº¦çš„å†…å®¹
            document.getElementById('coordinates').textContent = lat + ', ' + lng;
        });

        // å½“é¼ æ ‡ç§»å‡ºåœ°å›¾æ—¶ï¼Œæ¸…ç©ºæ˜¾ç¤º
        map.on('mouseout', function () {
            document.getElementById('coordinates').textContent = '-';
        });
    </script>
</body>

</html>